<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ready-Mix Concrete System Sizing Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div class="bg-white p-8 rounded-lg shadow-lg w-full max-w-4xl">
        <h1 class="text-2xl font-bold mb-2 text-center text-indigo-600">Ready-Mix Concrete System Sizing Calculator</h1>
        <p class="text-sm text-gray-600 text-center mb-4">Values shown are default values.</p>
        
        <!-- Tabs -->
        <div class="border-b border-gray-200 mb-6">
            <nav class="flex space-x-4">
                <button id="tab-overview" class="tab-button px-4 py-2 font-semibold text-indigo-600 border-b-2 border-indigo-600">General Overview</button>
                <button id="tab-materials" class="tab-button px-4 py-2 font-semibold text-gray-600">Material Properties</button>
                <button id="tab-hopper" class="tab-button px-4 py-2 font-semibold text-gray-600">Steel Hopper Heating</button>
            </nav>
        </div>

        <!-- General Overview Tab -->
        <div id="content-overview" class="tab-content">
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-indigo-600">Customer Information</h2>
                <div class="mb-4">
                    <label for="customer" class="block text-sm font-medium text-gray-700">Customer</label>
                    <input type="text" id="customer" value="" class="mt-1 block w-full p-2 border border-gray-300 rounded-md">
                </div>
            </div>
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-indigo-600">Unit System</h2>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-overview" value="metric" checked class="mr-2" onchange="updateUnits('overview')">
                        <span class="text-sm text-gray-700">Metric (m³, °C)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-overview" value="imperial" class="mr-2" onchange="updateUnits('overview')">
                        <span class="text-sm text-gray-700">Imperial (yd³, °F)</span>
                    </label>
                </div>
            </div>
            <form id="calcForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Batching Inputs -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">Batching Parameters</h2>
                        <div class="mb-4">
                            <label for="batchRate" class="block text-sm font-medium text-gray-700" data-label="batchRate">Batching Rate (m³/hr)</label>
                            <input type="number" id="batchRate" value="60.00" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="dailyBatch" class="block text-sm font-medium text-gray-700" data-label="dailyBatch">Daily Production (m³/day)</label>
                            <input type="number" id="dailyBatch" value="120" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="truckSize" class="block text-sm font-medium text-gray-700" data-label="truckSize">Truck Size (m³)</label>
                            <input type="number" id="truckSize" value="10.00" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                    </div>
                    <!-- Temperature Inputs -->
                    <div class="bg-pink-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">Temperature Settings</h2>
                        <div class="mb-4">
                            <label for="sandStartTemp" class="block text-sm font-medium text-gray-700" data-label="sandStartTemp">Sand Start Temp (°C)</label>
                            <input type="number" id="sandStartTemp" value="-10.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements(); updateHopperHeatingTable()">
                        </div>
                        <div class="mb-4">
                            <label for="sandEndTemp" class="block text-sm font-medium text-gray-700" data-label="sandEndTemp">Sand Desired Temp (°C)</label>
                            <input type="number" id="sandEndTemp" value="48.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements(); updateHopperHeatingTable()">
                        </div>
                        <div class="mb-4">
                            <label for="stoneStartTemp" class="block text-sm font-medium text-gray-700" data-label="stoneStartTemp">Stone Start Temp (°C)</label>
                            <input type="number" id="stoneStartTemp" value="-10.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements(); updateHopperHeatingTable()">
                        </div>
                        <div class="mb-4">
                            <label for="stoneEndTemp" class="block text-sm font-medium text-gray-700" data-label="stoneEndTemp">Stone Desired Temp (°C)</label>
                            <input type="number" id="stoneEndTemp" value="10.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements(); updateHopperHeatingTable()">
                        </div>
                    </div>
                    <!-- Water Tank Inputs -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-*;600">Water Tank Parameters</h2>
                        <div class="mb-4">
                            <label for="tankSize" class="block text-sm font-medium text-gray-700" data-label="tankSize">Tank Size (Liters)</label>
                            <input type="number" id="tankSize" value="11000.00" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="saddleTankSize" class="block text-sm font-medium text-gray-700" data-label="saddleTankSize">Saddle Tank Size (Liters)</label>
                            <input type="number" id="saddleTankSize" value="397.00" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="waterStartTemp" class="block text-sm font-medium text-gray-700" data-label="waterStartTemp">Water Start Temp (°C)</label>
                            <input type="number" id="waterStartTemp" value="4.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBlendedTemp(); updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="waterEndTemp" class="block text-sm font-medium text-gray-700" data-label="waterEndTemp">Water Desired Temp (°C)</label>
                            <input type="number" id="waterEndTemp" value="60.0" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBlendedTemp(); updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="hotWaterRatio" class="block text-sm font-medium text-gray-700">Hot Water Blend Ratio (%)</label>
                            <input type="number" id="hotWaterRatio" value="80" step="1" min="0" max="100" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBlendedTemp(); updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="blendedTempDisplay" class="block text-sm font-medium text-gray-700" data-label="blendedTempDisplay">Blended Water Temp (°C)</label>
                            <input type="number" id="blendedTempDisplay" value="48.8" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                        </div>
                    </div>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg">
                    <h2 class="text-lg font-semibold mb-2 text-indigo-600">Steam Generator Models</h2>
                    <div class="flex space-x-4 mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="st102" value="800000" checked class="mr-2">
                            <span class="text-sm text-gray-700">ST102 (800,000 BTU/HR)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="st302" value="2400000" checked class="mr-2">
                            <span class="text-sm text-gray-700">ST302 (2,400,000 BTU/HR)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="st502" value="4000000" checked class="mr-2">
                            <span class="text-sm text-gray-700">ST502 (4,000,000 BTU/HR)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" id="st602" value="6000000" checked class="mr-2">
                            <span class="text-sm text-gray-700">ST602 (6,000,000 BTU/HR)</span>
                        </label>
                    </div>
                    <h2 class="text-lg font-semibold mb-2 text-indigo-600">Heating Configuration</h2>
                    <div class="flex space-x-4">
                        <button type="button" id="btn-everything" class="w-full bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 text-sm">Everything On-Demand</button>
                        <button type="button" id="btn-water" class="w-full bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700 text-sm">Water On-Demand</button>
                    </div>
                </div>
            </form>
            <div id="result" class="mt-6"></div>
        </div>

        <!-- Material Properties Tab -->
        <div id="content-materials" class="tab-content hidden">
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-indigo-600">Unit System</h2>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-materials" value="metric" checked class="mr-2" onchange="updateUnits('materials')">
                        <span class="text-sm text-gray-700">Metric (m³, °C)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-materials" value="imperial" class="mr-2" onchange="updateUnits('materials')">
                        <span class="text-sm text-gray-700">Imperial (yd³, °F)</span>
                    </label>
                </div>
            </div>
            <form id="materialsForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Specific Weights -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">Specific Weights (Bulk Density)</h2>
                        <div class="mb-4">
                            <label for="sandWeight" class="block text-sm font-medium text-gray-700" data-label="sandWeight">Sand Weight (kg/m³)</label>
                            <input type="number" id="sandWeight" value="1681.94" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="stoneWeight" class="block text-sm font-medium text-gray-700" data-label="stoneWeight">Stone Weight (kg/m³)</label>
                            <input type="number" id="stoneWeight" value="1762.04" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="waterWeight" class="block text-sm font-medium text-gray-700" data-label="waterWeight">Water Weight (kg/m³)</label>
                            <input type="number" id="waterWeight" value="1000.00" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                    </div>
                    <!-- Specific Heats -->
                    <div class="bg-pink-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">Specific Heats</h2>
                        <div class="mb-4">
                            <label for="sandSpecificHeat" class="block text-sm font-medium text-gray-700" data-label="sandSpecificHeat">Sand Specific Heat (kJ/kg·°C)</label>
                            <input type="number" id="sandSpecificHeat" value="0.829" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="stoneSpecificHeat" class="block text-sm font-medium text-gray-700" data-label="stoneSpecificHeat">Stone Specific Heat (kJ/kg·°C)</label>
                            <input type="number" id="stoneSpecificHeat" value="0.871" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="waterSpecificHeat" class="block text-sm font-medium text-gray-700" data-label="waterSpecificHeat">Water Specific Heat (kJ/kg·°C)</label>
                            <input type="number" id="waterSpecificHeat" value="4.187" step="0.001" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                    </div>
                    <!-- Nominal Mix Ratios -->
                    <div class="bg-yellow-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600" data-label="mixRatioTitle">Nominal Mix Ratios (per m³ of Concrete)</h2>
                        <div class="mb-4">
                            <label for="sandMixRatio" class="block text-sm font-medium text-gray-700" data-label="sandMixRatio">Sand (kg/m³)</label>
                            <input type="number" id="sandMixRatio" value="700.00" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="stoneMixRatio" class="block text-sm font-medium text-gray-700" data-label="stoneMixRatio">Stone (kg/m³)</label>
                            <input type="number" id="stoneMixRatio" value="1200.00" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                        <div class="mb-4">
                            <label for="waterMixRatio" class="block text-sm font-medium text-gray-700" data-label="waterMixRatio">Water (kg/m³)</label>
                            <input type="number" id="waterMixRatio" value="150.00" step="0.1" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateBtuRequirements()">
                        </div>
                    </div>
                    <!-- BTU/HR Requirements Display -->
                    <div class="bg-teal-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">BTU/HR Requirements</h2>
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-gray-700" data-label="btuPerUnit">Per Unit of Batching Rate (batchRateM3 = 1 m³/hr):</label>
                            <div class="mt-1 space-y-2">
                                <p class="text-sm text-gray-700"><strong>Sand:</strong> <span id="sandBtuDisplay">N/A</span></p>
                                <p class="text-sm text-gray-700"><strong>Stone:</strong> <span id="stoneBtuDisplay">N/A</span></p>
                            </div>
                        </div>
                    </div>
                </div>
                <button type="button" onclick="updateMaterialProperties()" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 text-sm">Save Material Properties</button>
            </form>
            <!-- Reference Table for Material Properties -->
            <div class="mt-6 bg-purple-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-indigo-600">Reference Material Properties</h2>
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-indigo-600 text-white">
                            <th class="border p-2 text-left text-sm">Material</th>
                            <th class="border p-2 text-left text-sm" data-label="referenceWeight">Specific Weight (lb/ft³)</th>
                            <th class="border p-2 text-left text-sm" data-label="referenceSpecificHeat">Specific Heat (BTU/lb·°F)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="bg-yellow-100">
                            <td class="border p-2 text-gray-700 text-sm">Sand 5mm (Dry)</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-sand5mmdry-weight">105.00</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-sand5mmdry-specificheat">0.1988</td>
                        </tr>
                        <tr class="bg-gray-100">
                            <td class="border p-2 text-gray-700 text-sm">19mm Stone / 3/4" Rock (57 Rock)</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-19mmstone34rock57rock-weight">110.00</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-19mmstone34rock57rock-specificheat">0.208</td>
                        </tr>
                        <tr class="bg-purple-100">
                            <td class="border p-2 text-gray-700 text-sm">10mm Stone / 3/8" Rock</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-10mmstone38rock-weight">105.00</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-10mmstone38rock-specificheat">0.308</td>
                        </tr>
                        <tr class="bg-pink-100">
                            <td class="border p-2 text-gray-700 text-sm">Limestone</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-limestone-weight">165.00</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-limestone-specificheat">0.228</td>
                        </tr>
                        <tr class="bg-blue-100">
                            <td class="border p-2 text-gray-700 text-sm">Water</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-water-weight">62.43</td>
                            <td class="border p-2 text-gray-700 text-sm" id="ref-water-specificheat">1.000</td>
                        </tr>
                    </tbody>
                </table>
                <p class="mt-2 text-sm text-gray-600">Note: Use these values as a reference when adjusting material properties above.</p>
            </div>
        </div>

        <!-- Steel Hopper Heating Tab -->
        <div id="content-hopper" class="tab-content hidden">
            <div class="mb-6 bg-blue-50 p-4 rounded-lg">
                <h2 class="text-lg font-semibold mb-2 text-indigo-600">Unit System</h2>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-hopper" value="metric" checked class="mr-2" onchange="updateUnits('hopper')">
                        <span class="text-sm text-gray-700">Metric (m³, °C)</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="unitSystem-hopper" value="imperial" class="mr-2" onchange="updateUnits('hopper')">
                        <span class="text-sm text-gray-700">Imperial (yd³, °F)</span>
                    </label>
                </div>
            </div>
            <form id="hopperForm" class="space-y-6">
                <div class="grid grid-cols-1 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h2 class="text-lg font-semibold mb-2 text-indigo-600">Hopper Parameters</h2>
                        <div class="mb-4">
                            <label for="hopperAmount" class="block text-sm font-medium text-gray-700" data-label="hopperAmount">Hopper Holding Amount (Metric Tonnes)</label>
                            <input type="number" id="hopperAmount" value="30.00" step="0.01" class="mt-1 block w-full p-2 border border-gray-300 rounded-md" required oninput="updateHopperHeatingTable()">
                        </div>
                    </div>
                </div>
                <div id="hopperHeatingTable" class="mt-6 bg-teal-50 p-4 rounded-lg"></div>
            </form>
        </div>
    </div>

<script>
    // Access jsPDF
    const { jsPDF } = window.jspdf;

    // Conversion factors (defined first)
    const cubicMToYards = 1.30795062;
    const cubicYardsToM = 1 / cubicMToYards;
    const kgPerCuMToLbPerCuFt = 0.06242796;
    const lbPerCuFtToKgPerCuM = 1 / kgPerCuMToLbPerCuFt;
    const litersToGallons = 0.264172052;
    const gallonsToLiters = 1 / litersToGallons;
    const kJPerKgCToBtuPerLbF = 0.238845900159; // Updated to more precise value
    const kgPerCuMToLbPerCuYd = 2.20462262 / cubicMToYards;
    const lbPerCuYdToKgPerCuM = 1 / kgPerCuMToLbPerCuYd;
    const kgToLbs = 2.20462262185; // Updated to more precise value
    const lbsPerGallon = 8.345404;
    const metricTonneToKg = 1000;
    const usTonToLbs = 2000;
    const metricTonneToUsTon = 1.10231;
    const usTonToMetricTonne = 0.907185;

    // Material properties (in metric)
    let materialProperties = {
        sandWeight: 1681.94,
        stoneWeight: 1762.04,
        waterWeight: 1000.00,
        sandSpecificHeat: 0.829,
        stoneSpecificHeat: 0.871,
        waterSpecificHeat: 4.187,
        saddleTankSize: 397.00,
        sandMixRatio: 700.00,
        stoneMixRatio: 1200.00,
        waterMixRatio: 150.00,
        hopperAmount: 30.00 // Metric Tonnes
    };

    // Reference material properties (in imperial: lb/ft³, BTU/lb·°F)
    const referenceMaterials = [
        { name: "Sand 5mm (Dry)", id: "sand5mmdry", weight: 105.00, specificHeat: 0.1988 },
        { name: "19mm Stone / 3/4\" Rock (57 Rock)", id: "19mmstone34rock57rock", weight: 110.00, specificHeat: 0.208 },
        { name: "10mm Stone / 3/8\" Rock", id: "10mmstone38rock", weight: 105.00, specificHeat: 0.308 },
        { name: "Limestone", id: "limestone", weight: 165.00, specificHeat: 0.228 },
        { name: "Water", id: "water", weight: 62.43, specificHeat: 1.000 }
    ];

    // Default values (metric)
    const defaultValuesMetric = {
        batchRate: 60.00,
        dailyBatch: 120,
        truckSize: 10.00,
        sandStartTemp: -10.0,
        sandEndTemp: 48.0,
        stoneStartTemp: -10.0,
        stoneEndTemp: 10.0,
        tankSize: 11000,
        saddleTankSize: 397,
        waterStartTemp: 4.0,
        waterEndTemp: 60.0,
        hotWaterRatio: 80,
        hopperAmount: 30.00,
        customer: ''
    };

    let lastUnitSystem = 'metric';

    function celsiusToFahrenheit(c) {
        return (c * 9 / 5) + 32;
    }

    function fahrenheitToCelsius(f) {
        return (f - 32) * 5 / 9;
    }

    function updateBlendedTemp() {
        const unitSystem = lastUnitSystem;
        const isMetric = unitSystem === 'metric';
        let waterStartTemp = parseFloat(document.getElementById('waterStartTemp').value);
        let waterEndTemp = parseFloat(document.getElementById('waterEndTemp').value);
        const hotWaterRatio = parseFloat(document.getElementById('hotWaterRatio').value) / 100;

        if (isNaN(waterStartTemp) || isNaN(waterEndTemp) || isNaN(hotWaterRatio)) {
            document.getElementById('blendedTempDisplay').value = '';
            return;
        }

        if (!isMetric) {
            waterStartTemp = fahrenheitToCelsius(waterStartTemp);
            waterEndTemp = fahrenheitToCelsius(waterEndTemp);
        }

        const blendedTempC = (waterEndTemp * hotWaterRatio) + (waterStartTemp * (1 - hotWaterRatio));
        const blendedTemp = isMetric ? blendedTempC : celsiusToFahrenheit(blendedTempC);
        document.getElementById('blendedTempDisplay').value = blendedTemp.toFixed(1);
    }

    function updateBtuRequirements() {
        const unitSystem = lastUnitSystem;
        const isMetric = unitSystem === 'metric';

        const inputs = {
            batchRate: document.getElementById('batchRate'),
            truckSize: document.getElementById('truckSize'),
            sandStartTemp: document.getElementById('sandStartTemp'),
            sandEndTemp: document.getElementById('sandEndTemp'),
            stoneStartTemp: document.getElementById('stoneStartTemp'),
            stoneEndTemp: document.getElementById('stoneEndTemp'),
            saddleTankSize: document.getElementById('saddleTankSize'),
            waterStartTemp: document.getElementById('waterStartTemp'),
            waterEndTemp: document.getElementById('waterEndTemp'),
            hotWaterRatio: document.getElementById('hotWaterRatio')
        };

        if (Object.values(inputs).some(input => !input)) {
            document.getElementById('sandBtuDisplay').textContent = 'N/A';
            document.getElementById('stoneBtuDisplay').textContent = 'N/A';
            return;
        }

        let batchRate = parseFloat(inputs.batchRate.value);
        let truckSize = parseFloat(inputs.truckSize.value);
        let sandStartTemp = parseFloat(inputs.sandStartTemp.value);
        let sandEndTemp = parseFloat(inputs.sandEndTemp.value);
        let stoneStartTemp = parseFloat(inputs.stoneStartTemp.value);
        let stoneEndTemp = parseFloat(inputs.stoneEndTemp.value);
        let saddleTankSize = parseFloat(inputs.saddleTankSize.value);
        let waterStartTemp = parseFloat(inputs.waterStartTemp.value);
        let waterEndTemp = parseFloat(inputs.waterEndTemp.value);
        const hotWaterRatio = parseFloat(inputs.hotWaterRatio.value) / 100;

        if ([batchRate, truckSize, sandStartTemp, sandEndTemp, stoneStartTemp, stoneEndTemp, saddleTankSize, waterStartTemp, waterEndTemp, hotWaterRatio].some(val => isNaN(val))) {
            document.getElementById('sandBtuDisplay').textContent = 'N/A';
            document.getElementById('stoneBtuDisplay').textContent = 'N/A';
            return;
        }

        let batchRateM3 = isMetric ? batchRate : batchRate * cubicYardsToM;
        let truckSizeM3 = isMetric ? truckSize : truckSize * cubicYardsToM;
        let sandStartTempF = isMetric ? celsiusToFahrenheit(sandStartTemp) : sandStartTemp;
        let sandEndTempF = isMetric ? celsiusToFahrenheit(sandEndTemp) : sandEndTemp;
        let stoneStartTempF = isMetric ? celsiusToFahrenheit(stoneStartTemp) : stoneStartTemp;
        let stoneEndTempF = isMetric ? celsiusToFahrenheit(stoneEndTemp) : stoneEndTemp;
        let saddleTankGallons = isMetric ? saddleTankSize * litersToGallons : saddleTankSize;
        let waterStartTempF = isMetric ? celsiusToFahrenheit(waterStartTemp) : waterStartTemp;
        let waterEndTempF = isMetric ? celsiusToFahrenheit(waterEndTemp) : waterEndTemp;

        const sandSpecificHeatBtu = materialProperties.sandSpecificHeat * kJPerKgCToBtuPerLbF;
        const stoneSpecificHeatBtu = materialProperties.stoneSpecificHeat * kJPerKgCToBtuPerLbF;
        const waterSpecificHeatBtu = materialProperties.waterSpecificHeat * kJPerKgCToBtuPerLbF;

        const sandLbsPerUnit = materialProperties.sandMixRatio * kgToLbs;
        const stoneLbsPerUnit = materialProperties.stoneMixRatio * kgToLbs;
        const waterLbsPerUnit = materialProperties.waterMixRatio * kgToLbs;
        const trucksPerUnit = 1 / truckSizeM3;
        const saddleWaterLbsPerUnit = saddleTankGallons * lbsPerGallon;

        const hotWaterLbsPerUnit = (waterLbsPerUnit * hotWaterRatio) + (saddleWaterLbsPerUnit * hotWaterRatio);

        const sandBtuPerUnit = sandLbsPerUnit * sandSpecificHeatBtu * (sandEndTempF - sandStartTempF);
        const stoneBtuPerUnit = stoneLbsPerUnit * stoneSpecificHeatBtu * (stoneEndTempF - stoneStartTempF);
        let waterBtuPerUnit;
        const thresholdTempF = 140;
        if (waterEndTempF <= thresholdTempF) {
            waterBtuPerUnit = hotWaterLbsPerUnit * waterSpecificHeatBtu * (waterEndTempF - waterStartTempF) * 1.2;
        } else {
            const btuUpToThreshold = hotWaterLbsPerUnit * waterSpecificHeatBtu * (thresholdTempF - waterStartTempF) * 1.2;
            const deltaAboveThreshold = waterEndTempF - thresholdTempF;
            const btuAboveThreshold = hotWaterLbsPerUnit * waterSpecificHeatBtu * deltaAboveThreshold * 3.9;
            waterBtuPerUnit = btuUpToThreshold + btuAboveThreshold;
        }

        const sandBtuTotal = sandBtuPerUnit * batchRateM3;
        const stoneBtuTotal = stoneBtuPerUnit * batchRateM3;
        const waterBtuTotal = waterBtuPerUnit * batchRateM3;

        const batchUnit = isMetric ? 'm³/hr' : 'yd³/hr';
        document.querySelector('#content-materials [data-label="btuPerUnit"]').textContent = `Per Unit of Batching Rate (batchRateM3 = 1 ${batchUnit}):`;
        document.getElementById('sandBtuDisplay').textContent = `${sandLbsPerUnit.toFixed(3)} x ${sandSpecificHeatBtu.toFixed(3)} x ${(sandEndTempF - sandStartTempF).toFixed(1)} = ${sandBtuTotal.toLocaleString(undefined, {maximumFractionDigits: 2})} BTU/hr (${sandBtuPerUnit.toLocaleString(undefined, {maximumFractionDigits: 2})} per ${batchUnit})`;
        document.getElementById('stoneBtuDisplay').textContent = `${stoneLbsPerUnit.toFixed(3)} x ${stoneSpecificHeatBtu.toFixed(3)} x ${(stoneEndTempF - stoneStartTempF).toFixed(1)} = ${stoneBtuTotal.toLocaleString(undefined, {maximumFractionDigits: 2})} BTU/hr (${stoneBtuPerUnit.toLocaleString(undefined, {maximumFractionDigits: 2})} per ${batchUnit})`;
    }

    function updateHopperHeatingTable() {
        const unitSystem = lastUnitSystem;
        const isMetric = unitSystem === 'metric';

        const inputs = {
            hopperAmount: document.getElementById('hopperAmount'),
            sandStartTemp: document.getElementById('sandStartTemp'),
            sandEndTemp: document.getElementById('sandEndTemp'),
            stoneStartTemp: document.getElementById('stoneStartTemp'),
            stoneEndTemp: document.getElementById('stoneEndTemp')
        };

        if (Object.values(inputs).some(input => !input)) {
            document.getElementById('hopperHeatingTable').innerHTML = '<p class="text-red-600 text-sm">Error: Required input fields are missing.</p>';
            return;
        }

        const values = {
            hopperAmount: parseFloat(inputs.hopperAmount.value),
            sandStartTemp: parseFloat(inputs.sandStartTemp.value),
            sandEndTemp: parseFloat(inputs.sandEndTemp.value),
            stoneStartTemp: parseFloat(inputs.stoneStartTemp.value),
            stoneEndTemp: parseFloat(inputs.stoneEndTemp.value)
        };

        if (Object.values(values).some(val => isNaN(val))) {
            document.getElementById('hopperHeatingTable').innerHTML = '<p class="text-red-600 text-sm">Please enter valid numbers for all fields.</p>';
            return;
        }

        let massLbs = isMetric ? values.hopperAmount * metricTonneToKg * kgToLbs : values.hopperAmount * usTonToLbs;
        let sandStartTempF = isMetric ? celsiusToFahrenheit(values.sandStartTemp) : values.sandStartTemp;
        let sandEndTempF = isMetric ? celsiusToFahrenheit(values.sandEndTemp) : values.sandEndTemp;
        let stoneStartTempF = isMetric ? celsiusToFahrenheit(values.stoneStartTemp) : values.stoneStartTemp;
        let stoneEndTempF = isMetric ? celsiusToFahrenheit(values.stoneEndTemp) : values.stoneEndTemp;

        const sandSpecificHeatBtu = materialProperties.sandSpecificHeat * kJPerKgCToBtuPerLbF;
        const stoneSpecificHeatBtu = materialProperties.stoneSpecificHeat * kJPerKgCToBtuPerLbF;

        const sandDeltaT = sandEndTempF - sandStartTempF;
        const stoneDeltaT = stoneEndTempF - stoneStartTempF;

        const steamGenerators = [
            { model: 'ST102', btu: 800000 },
            { model: 'ST302', btu: 2400000 },
            { model: 'ST502', btu: 4000000 },
            { model: 'ST602', btu: 6000000 }
        ];

        let html = `
            <h3 class="text-md font-semibold mb-2 text-indigo-600">Hopper Heating Times</h3>
            <table class="w-full border-collapse">
                <thead>
                    <tr class="bg-indigo-600 text-white">
                        <th class="border p-2 text-left text-sm">Steam Generator Model</th>
                        <th class="border p-2 text-left text-sm">Sand Heat Time (hrs)</th>
                        <th class="border p-2 text-left text-sm">Stone Heat Time (hrs)</th>
                    </tr>
                </thead>
                <tbody>
        `;

        steamGenerators.forEach(gen => {
            const sandHeatTime = (massLbs * sandSpecificHeatBtu * sandDeltaT * 1.3) / gen.btu;
            const stoneHeatTime = (massLbs * stoneSpecificHeatBtu * stoneDeltaT * 1.3) / gen.btu;
            html += `
                <tr>
                    <td class="border p-2 text-gray-700 text-sm">${gen.model}</td>
                    <td class="border p-2 text-gray-700 text-sm">${sandHeatTime.toFixed(2)}</td>
                    <td class="border p-2 text-gray-700 text-sm">${stoneHeatTime.toFixed(2)}</td>
                </tr>
            `;
        });

        html += `
                </tbody>
            </table>
            <p class="mt-2 text-sm text-gray-600">Note: Heating times include a 30% safety margin for sand and stone.</p>
        `;
        document.getElementById('hopperHeatingTable').innerHTML = html;
    }

    function updateUnits(tab) {
        const previousUnitSystem = lastUnitSystem;
        const radioName = `unitSystem-${tab}`;
        const unitSystem = document.querySelector(`input[name="${radioName}"]:checked`).value;
        lastUnitSystem = unitSystem;
        const isMetric = unitSystem === 'metric';
        const wasMetric = previousUnitSystem === 'metric';

        // Synchronize all tabs' radio buttons to match lastUnitSystem
        ['overview', 'materials', 'hopper'].forEach(t => {
            const metricRadio = document.querySelector(`input[name="unitSystem-${t}"][value="metric"]`);
            const imperialRadio = document.querySelector(`input[name="unitSystem-${t}"][value="imperial"]`);
            if (metricRadio && imperialRadio) {
                metricRadio.checked = isMetric;
                imperialRadio.checked = !isMetric;
            }
        });

        const labels = {
            batchRate: isMetric ? 'Batching Rate (m³/hr)' : 'Batching Rate (yd³/hr)',
            dailyBatch: isMetric ? 'Daily Production (m³/day)' : 'Daily Production (yd³/day)',
            truckSize: isMetric ? 'Truck Size (m³)' : 'Truck Size (yd³)',
            sandWeight: isMetric ? 'Sand Weight (kg/m³)' : 'Sand Weight (lb/ft³)',
            sandSpecificHeat: isMetric ? 'Sand Specific Heat (kJ/kg·°C)' : 'Sand Specific Heat (BTU/lb·°F)',
            sandMixRatio: isMetric ? 'Sand (kg/m³)' : 'Sand (lb/yd³)',
            stoneWeight: isMetric ? 'Stone Weight (kg/m³)' : 'Stone Weight (lb/ft³)',
            stoneSpecificHeat: isMetric ? 'Stone Specific Heat (kJ/kg·°C)' : 'Stone Specific Heat (BTU/lb·°F)',
            stoneMixRatio: isMetric ? 'Stone (kg/m³)' : 'Stone (lb/yd³)',
            waterWeight: isMetric ? 'Water Weight (kg/m³)' : 'Water Weight (lb/ft³)',
            waterSpecificHeat: isMetric ? 'Water Specific Heat (kJ/kg·°C)' : 'Water Specific Heat (BTU/lb·°F)',
            waterMixRatio: isMetric ? 'Water (kg/m³)' : 'Water (lb/yd³)',
            sandStartTemp: isMetric ? 'Sand Start Temp (°C)' : 'Sand Start Temp (°F)',
            sandEndTemp: isMetric ? 'Sand Desired Temp (°C)' : 'Sand Desired Temp (°F)',
            stoneStartTemp: isMetric ? 'Stone Start Temp (°C)' : 'Stone Start Temp (°F)',
            stoneEndTemp: isMetric ? 'Stone Desired Temp (°C)' : 'Stone Desired Temp (°F)',
            tankSize: isMetric ? 'Tank Size (Liters)' : 'Tank Size (US Gallons)',
            saddleTankSize: isMetric ? 'Saddle Tank Size (Liters)' : 'Saddle Tank Size (US Gallons)',
            waterStartTemp: isMetric ? 'Water Start Temp (°C)' : 'Water Start Temp (°F)',
            waterEndTemp: isMetric ? 'Water Desired Temp (°C)' : 'Water Desired Temp (°F)',
            blendedTempDisplay: isMetric ? 'Blended Water Temp (°C)' : 'Blended Water Temp (°F)',
            btuPerUnit: isMetric ? 'Per Unit of Batching Rate (batchRateM3 = 1 m³/hr):' : 'Per Unit of Batching Rate (batchRateM3 = 1 yd³/hr):',
            mixRatioTitle: isMetric ? 'Nominal Mix Ratios (per m³ of Concrete)' : 'Nominal Mix Ratios (per yd³ of Concrete)',
            hopperAmount: isMetric ? 'Hopper Holding Amount (Metric Tonnes)' : 'Hopper Holding Amount (US Tons)',
            referenceWeight: isMetric ? 'Specific Weight (kg/m³)' : 'Specific Weight (lb/ft³)',
            referenceSpecificHeat: isMetric ? 'Specific Heat (kJ/kg·°C)' : 'Specific Heat (BTU/lb·°F)'
        };

        for (const [id, text] of Object.entries(labels)) {
            const labelElements = document.querySelectorAll(`[data-label="${id}"]`);
            labelElements.forEach(label => {
                if (label) label.textContent = text;
            });
        }

        const calcFields = {
            batchRate: {
                toMetric: v => wasMetric ? v : v * cubicYardsToM,
                toImperial: v => wasMetric ? v * cubicMToYards : v
            },
            dailyBatch: {
                toMetric: v => wasMetric ? v : v * cubicYardsToM,
                toImperial: v => wasMetric ? v * cubicMToYards : v
            },
            truckSize: {
                toMetric: v => wasMetric ? v : v * cubicYardsToM,
                toImperial: v => wasMetric ? v * cubicMToYards : v
            },
            sandStartTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            sandEndTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            stoneStartTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            stoneEndTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            tankSize: {
                toMetric: v => wasMetric ? v : v * gallonsToLiters,
                toImperial: v => wasMetric ? v * litersToGallons : v
            },
            saddleTankSize: {
                toMetric: v => wasMetric ? v : v * gallonsToLiters,
                toImperial: v => wasMetric ? v * litersToGallons : v
            },
            waterStartTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            waterEndTemp: {
                toMetric: v => wasMetric ? v : fahrenheitToCelsius(v),
                toImperial: v => wasMetric ? celsiusToFahrenheit(v) : v
            },
            hotWaterRatio: {
                toMetric: v => v,
                toImperial: v => v
            },
            hopperAmount: {
                toMetric: v => wasMetric ? v : v * usTonToMetricTonne,
                toImperial: v => wasMetric ? v * metricTonneToUsTon : v
            }
        };

        for (const [id, converters] of Object.entries(calcFields)) {
            const input = document.getElementById(id);
            if (input) {
                const currentValue = parseFloat(input.value);
                if (!isNaN(currentValue)) {
                    const convertedValue = isMetric ? converters.toMetric(currentValue) : converters.toImperial(currentValue);
                    input.value = convertedValue.toFixed(id.includes('Temp') ? 1 : id === 'hotWaterRatio' ? 0 : 2);
                }
            }
        }

        const materialFields = {
            sandWeight: isMetric ? v => v : v => v * kgPerCuMToLbPerCuFt,
            stoneWeight: isMetric ? v => v : v => v * kgPerCuMToLbPerCuFt,
            waterWeight: isMetric ? v => v : v => v * kgPerCuMToLbPerCuFt,
            sandSpecificHeat: isMetric ? v => v : v => v * kJPerKgCToBtuPerLbF,
            stoneSpecificHeat: isMetric ? v => v : v => v * kJPerKgCToBtuPerLbF,
            waterSpecificHeat: isMetric ? v => v : v => v * kJPerKgCToBtuPerLbF,
            sandMixRatio: isMetric ? v => v : v => v * kgPerCuMToLbPerCuYd,
            stoneMixRatio: isMetric ? v => v : v => v * kgPerCuMToLbPerCuYd,
            waterMixRatio: isMetric ? v => v : v => v * kgPerCuMToLbPerCuYd
        };

        for (const [id, converter] of Object.entries(materialFields)) {
            const input = document.getElementById(id);
            const value = materialProperties[id];
            if (input && !isNaN(value)) {
                input.value = converter(value).toFixed(id.includes('SpecificHeat') ? 3 : id.includes('MixRatio') ? 2 : 2);
            }
        }

        try {
            referenceMaterials.forEach((material, index) => {
                const weightElement = document.getElementById(`ref-${material.id}-weight`);
                const specificHeatElement = document.getElementById(`ref-${material.id}-specificheat`);
                if (weightElement && specificHeatElement) {
                    const weight = isMetric ? (material.weight * lbPerCuFtToKgPerCuM) : material.weight;
                    const specificHeat = isMetric ? (material.specificHeat / kJPerKgCToBtuPerLbF) : material.specificHeat;
                    weightElement.textContent = weight.toFixed(index === 4 ? 3 : 2);
                    specificHeatElement.textContent = specificHeat.toFixed(index === 0 ? 4 : index === 4 ? 3 : 3);
                } else {
                    console.warn(`Reference table element not found for material: ${material.name}`);
                }
            });
        } catch (error) {
            console.error('Error updating reference table:', error);
        }

        updateBlendedTemp();
        updateBtuRequirements();
        updateHopperHeatingTable();
    }

    function updateMaterialProperties() {
        const unitSystem = lastUnitSystem;
        const isMetric = unitSystem === 'metric';

        const materialFields = {
            sandWeight: isMetric ? v => v : v => v * lbPerCuFtToKgPerCuM,
            stoneWeight: isMetric ? v => v : v => v * lbPerCuFtToKgPerCuM,
            waterWeight: isMetric ? v => v : v => v * lbPerCuFtToKgPerCuM,
            sandSpecificHeat: isMetric ? v => v : v => v / kJPerKgCToBtuPerLbF,
            stoneSpecificHeat: isMetric ? v => v : v => v / kJPerKgCToBtuPerLbF,
            waterSpecificHeat: isMetric ? v => v : v => v / kJPerKgCToBtuPerLbF,
            sandMixRatio: isMetric ? v => v : v => v * lbPerCuYdToKgPerCuM,
            stoneMixRatio: isMetric ? v => v : v => v * lbPerCuYdToKgPerCuM,
            waterMixRatio: isMetric ? v => v : v => v * lbPerCuYdToKgPerCuM
        };

        for (const [id, converter] of Object.entries(materialFields)) {
            const input = document.getElementById(id);
            const value = parseFloat(input.value);
            if (!isNaN(value)) {
                materialProperties[id] = converter(value);
            }
        }

        alert('Material properties updated successfully!');
        updateBtuRequirements();
    }

function calculateSizing(mode) {
    const unitSystem = lastUnitSystem;
    const isMetric = unitSystem === 'metric';

    let batchRate = parseFloat(document.getElementById('batchRate').value);
    let dailyBatch = parseFloat(document.getElementById('dailyBatch').value);
    let truckSize = parseFloat(document.getElementById('truckSize').value);
    let sandStartTemp = parseFloat(document.getElementById('sandStartTemp').value);
    let sandEndTemp = parseFloat(document.getElementById('sandEndTemp').value);
    let stoneStartTemp = parseFloat(document.getElementById('stoneStartTemp').value);
    let stoneEndTemp = parseFloat(document.getElementById('stoneEndTemp').value);
    let tankSize = parseFloat(document.getElementById('tankSize').value);
    let saddleTankSize = parseFloat(document.getElementById('saddleTankSize').value);
    let waterStartTemp = parseFloat(document.getElementById('waterStartTemp').value);
    let waterEndTemp = parseFloat(document.getElementById('waterEndTemp').value);
    let hotWaterRatio = parseFloat(document.getElementById('hotWaterRatio').value) / 100;
    let customer = document.getElementById('customer').value;

    if ([batchRate, dailyBatch, truckSize, sandStartTemp, sandEndTemp, stoneStartTemp, stoneEndTemp, tankSize, saddleTankSize, waterStartTemp, waterEndTemp, hotWaterRatio].some(val => isNaN(val))) {
        document.getElementById('result').innerHTML = '<p class="text-red-600 text-sm">Please enter valid numbers for all fields.</p>';
        return;
    }

    let batchRateM3 = isMetric ? batchRate : batchRate * cubicYardsToM;
    let dailyBatchM3 = isMetric ? dailyBatch : dailyBatch * cubicYardsToM;
    let truckSizeM3 = isMetric ? truckSize : truckSize * cubicYardsToM;
    let sandWeightLbsPerM3 = materialProperties.sandWeight * kgToLbs;
    let stoneWeightLbsPerM3 = materialProperties.stoneWeight * kgToLbs;
    let waterWeightLbsPerM3 = materialProperties.waterWeight * kgToLbs;
    let sandSpecificHeatBtu = materialProperties.sandSpecificHeat * kJPerKgCToBtuPerLbF;
    let stoneSpecificHeatBtu = materialProperties.stoneSpecificHeat * kJPerKgCToBtuPerLbF;
    let waterSpecificHeatBtu = materialProperties.waterSpecificHeat * kJPerKgCToBtuPerLbF;
    let sandStartTempF = isMetric ? celsiusToFahrenheit(sandStartTemp) : sandStartTemp;
    let sandEndTempF = isMetric ? celsiusToFahrenheit(sandEndTemp) : sandEndTemp;
    let stoneStartTempF = isMetric ? celsiusToFahrenheit(stoneStartTemp) : stoneStartTemp;
    let stoneEndTempF = isMetric ? celsiusToFahrenheit(stoneEndTemp) : stoneEndTemp;
    let tankSizeLiters = isMetric ? tankSize : tankSize * gallonsToLiters;
    let saddleTankLiters = isMetric ? saddleTankSize : saddleTankSize * gallonsToLiters;
    let waterStartTempF = isMetric ? celsiusToFahrenheit(waterStartTemp) : waterStartTemp;
    let waterEndTempF = isMetric ? celsiusToFahrenheit(waterEndTemp) : waterEndTemp;

    const lbsPerCuM = {
        sand: sandWeightLbsPerM3,
        stone: stoneWeightLbsPerM3,
        water: waterWeightLbsPerM3
    };

    const sandLbsPerHour = batchRateM3 * materialProperties.sandMixRatio * kgToLbs;
    const stoneLbsPerHour = batchRateM3 * materialProperties.stoneMixRatio * kgToLbs;
    const waterLbsPerHour = batchRateM3 * materialProperties.waterMixRatio * kgToLbs;

    const productionHours = dailyBatchM3 / batchRateM3;
    const sandLbsPerDay = sandLbsPerHour * productionHours;
    const stoneLbsPerDay = stoneLbsPerHour * productionHours;
    const waterLbsPerDay = waterLbsPerHour * productionHours;

    const trucksPerHour = Math.ceil(batchRateM3 / truckSizeM3);

    const waterLitersPerHour = batchRateM3 * materialProperties.waterMixRatio;
    const saddleWaterLitersPerHour = trucksPerHour * saddleTankLiters;
    const totalWaterLitersPerHour = waterLitersPerHour + saddleWaterLitersPerHour;
    const hotWaterLitersPerHour = totalWaterLitersPerHour * hotWaterRatio;

    const waterPerHourDisplay = isMetric ? waterLitersPerHour : waterLitersPerHour * litersToGallons;
    const saddleWaterPerHourDisplay = isMetric ? saddleWaterLitersPerHour : saddleWaterLitersPerHour * litersToGallons;
    const totalWaterPerHourDisplay = isMetric ? totalWaterLitersPerHour : totalWaterLitersPerHour * litersToGallons;
    const hotWaterPerHourDisplay = isMetric ? hotWaterLitersPerHour : hotWaterLitersPerHour * litersToGallons;

    const hotWaterLbsMixPerHour = waterLbsPerHour * hotWaterRatio;
    const hotWaterLbsSaddlePerHour = (saddleWaterLitersPerHour * (materialProperties.waterWeight * kgToLbs / 1000)) * hotWaterRatio;
    const totalHotWaterLbsPerHour = hotWaterLbsMixPerHour + hotWaterLbsSaddlePerHour;

    let sandBtuPerHour = sandLbsPerHour * sandSpecificHeatBtu * (sandEndTempF - sandStartTempF);
    let stoneBtuPerHour = stoneLbsPerHour * stoneSpecificHeatBtu * (stoneEndTempF - stoneStartTempF);

    let waterBtuPerHourIdeal = totalHotWaterLbsPerHour * waterSpecificHeatBtu * (waterEndTempF - waterStartTempF);
    let waterBtuPerHourHigh;
    const thresholdTempF = 140;
    if (waterEndTempF <= thresholdTempF) {
        waterBtuPerHourHigh = totalHotWaterLbsPerHour * waterSpecificHeatBtu * (waterEndTempF - waterStartTempF) * 1.2;
    } else {
        const btuUpToThreshold = totalHotWaterLbsPerHour * waterSpecificHeatBtu * (thresholdTempF - waterStartTempF) * 1.2;
        const deltaAboveThreshold = waterEndTempF - thresholdTempF;
        const btuAboveThreshold = totalHotWaterLbsPerHour * waterSpecificHeatBtu * deltaAboveThreshold * 3.9;
        waterBtuPerHourHigh = btuUpToThreshold + btuAboveThreshold;
    }

    // Apply safety factors for Realistic values, use let instead of const
    let sandBtuPerHourRealistic = sandBtuPerHour * 1.3; // 30% safety margin
    let stoneBtuPerHourRealistic = stoneBtuPerHour * 1.3; // 30% safety margin
    const waterBtuPerHourRealistic = waterBtuPerHourHigh; // Already includes safety factor (1.2 or 3.9)

    if (mode === 'water') {
        sandBtuPerHour = 0;
        stoneBtuPerHour = 0;
        sandBtuPerHourRealistic = 0; // Now this works since it's declared with let
        stoneBtuPerHourRealistic = 0; // Now this works since it's declared with let
    }

    const totalBtuPerfect = sandBtuPerHour + stoneBtuPerHour + waterBtuPerHourIdeal;
    const totalBtuReal = sandBtuPerHourRealistic + stoneBtuPerHourRealistic + waterBtuPerHourRealistic;

    // Debug check for NaN
    if (isNaN(totalBtuPerfect) || isNaN(totalBtuReal)) {
        document.getElementById('result').innerHTML = '<p class="text-red-600 text-sm">Calculation error: Invalid BTU values.</p>';
        return;
    }

    // Round to 6 decimal places to match expected precision
    const totalBtuPerfectDisplay = Number(totalBtuPerfect.toFixed(6)).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const totalBtuRealDisplay = Number(totalBtuReal.toFixed(2)).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const sandBtuRealisticDisplay = Number(sandBtuPerHourRealistic.toFixed(2)).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const stoneBtuRealisticDisplay = Number(stoneBtuPerHourRealistic.toFixed(2)).toLocaleString(undefined, { maximumFractionDigits: 2 });
    const waterBtuRealisticDisplay = Number(waterBtuPerHourRealistic.toFixed(2)).toLocaleString(undefined, { maximumFractionDigits: 2 });

    const steamGenerators = [
        { model: 'ST102', btu: 800000, checked: document.getElementById('st102').checked },
        { model: 'ST302', btu: 2400000, checked: document.getElementById('st302').checked },
        { model: 'ST502', btu: 4000000, checked: document.getElementById('st502').checked },
        { model: 'ST602', btu: 6000000, checked: document.getElementById('st602').checked }
    ].filter(gen => gen.checked);

    let btuPerLiter;
    if (waterEndTempF <= thresholdTempF) {
        btuPerLiter = (waterSpecificHeatBtu * (waterEndTempF - waterStartTempF) * 1.2);
    } else {
        const deltaUpToThreshold = thresholdTempF - waterStartTempF;
        const btuUpToThreshold = (waterSpecificHeatBtu * deltaUpToThreshold * 1.2);
        const deltaAboveThreshold = waterEndTempF - thresholdTempF;
        const btuAboveThreshold = (waterSpecificHeatBtu * deltaAboveThreshold * 3.9);
        btuPerLiter = (btuUpToThreshold + btuAboveThreshold);
    }

    const results = steamGenerators.map(gen => {
        const sandHoursSafety = ((sandLbsPerDay * sandSpecificHeatBtu * (sandEndTempF - sandStartTempF)) / gen.btu) * 1.3;
        const stoneHoursSafety = ((stoneLbsPerDay * stoneSpecificHeatBtu * (stoneEndTempF - stoneStartTempF)) / gen.btu) * 1.3;
        const fulltankHoursSafety = ((tankSizeLiters * (materialProperties.waterWeight * kgToLbs / 1000) * waterSpecificHeatBtu * (waterEndTempF - waterStartTempF)) / gen.btu) * 1.2;
        const waterRecoveryHoursSafety = ((totalHotWaterLbsPerHour * waterSpecificHeatBtu * (waterEndTempF - waterStartTempF)) / gen.btu) * 1.2;

        const effectiveBtuPerHour = gen.btu;
        const waterHeatedPerHourBase = (effectiveBtuPerHour / btuPerLiter) / (materialProperties.waterWeight * kgToLbs / 1000);
        const waterHeatedPerHour = isMetric ? waterHeatedPerHourBase : (waterHeatedPerHourBase * litersToGallons);
        const hotWaterDemandInSameUnit = hotWaterPerHourDisplay;
        const meetsHotWaterDemand = waterHeatedPerHour >= hotWaterDemandInSameUnit;
        const meetsTotalBtuRequirement = gen.btu >= totalBtuReal;

        return {
            model: gen.model,
            btu: gen.btu,
            sandHoursSafety: sandHoursSafety.toFixed(2),
            stoneHoursSafety: stoneHoursSafety.toFixed(2),
            fulltankHoursSafety: fulltankHoursSafety.toFixed(2),
            waterRecoveryHoursSafety: waterRecoveryHoursSafety.toFixed(2),
            waterHeatedPerHour: waterHeatedPerHour.toFixed(2),
            meetsHotWaterDemand: meetsHotWaterDemand ? 'Yes' : 'No',
            meetsTotalBtuRequirement: meetsTotalBtuRequirement ? 'Yes' : 'No',
            acceptable: meetsHotWaterDemand && meetsTotalBtuRequirement
        };
    });

    const volumeUnit = isMetric ? 'Liters' : 'US Gallons';
    const volumeRateUnit = isMetric ? 'Liters/hr' : 'US Gallons/hr';
    // Update the title based on mode
    const resultsTitle = mode === 'everything' ? 'System Sizing Results (Everything On-Demand)' : 'System Sizing Results (Water On-Demand)';
    let html = `
        <div class="bg-teal-50 p-4 rounded-lg">
            <h2 class="text-md font-semibold mb-2 text-indigo-600">${resultsTitle}</h2>
            <p class="mb-2 text-sm text-gray-700"><strong>Total BTU/HR Requirement (Ideal):</strong> ${totalBtuPerfectDisplay} BTU/hr</p>
    `;

    // Add breakdown for Everything On-Demand mode
    if (mode === 'everything') {
        html += `
            <p class="mb-2 text-sm text-gray-700"><strong>BTU/HR Requirement Sand (Realistic):</strong> ${sandBtuRealisticDisplay} BTU/hr</p>
            <p class="mb-2 text-sm text-gray-700"><strong>BTU/HR Requirement Stone (Realistic):</strong> ${stoneBtuRealisticDisplay} BTU/hr</p>
            <p class="mb-2 text-sm text-gray-700"><strong>BTU/HR Requirement Water (Realistic):</strong> ${waterBtuRealisticDisplay} BTU/hr</p>
        `;
    }

    html += `
            <p class="mb-4 text-sm text-gray-700"><strong>Total BTU/HR Requirement (Realistic):</strong> ${totalBtuRealDisplay} BTU/hr</p>
            <h3 class="text-sm font-semibold mb-2 text-indigo-600">Hot Water Demand</h3>
            <p class="mb-2 text-sm text-gray-700"><strong>Mix Water:</strong> ${waterPerHourDisplay.toFixed(2)} ${volumeRateUnit}</p>
            <p class="mb-2 text-sm text-gray-700"><strong>Saddle Tank Water:</strong> ${saddleWaterPerHourDisplay.toFixed(2)} ${volumeRateUnit}</p>
            <p class="mb-2 text-sm text-gray-700"><strong>Total Water Demand:</strong> ${totalWaterPerHourDisplay.toFixed(2)} ${volumeRateUnit}</p>
            <p class="mb-4 text-sm text-gray-700"><strong>Hot Water Demand:</strong> ${hotWaterPerHourDisplay.toFixed(2)} ${volumeRateUnit}</p>
            <h3 class="text-sm font-semibold mb-2 text-indigo-600">Steam Generator Sizing</h3>
            <table class="w-full border-collapse mb-4">
                <thead>
                    <tr class="bg-indigo-600 text-white">
                        <th class="border p-2 text-sm">Model</th>
                        <th class="border p-2 text-sm">Sand Heat Time (hrs)</th>
                        <th class="border p-2 text-sm">Stone Heat Time (hrs)</th>
                        <th class="border p-2 text-sm">Full Tank Heat Time (hrs)</th>
                        <th class="border p-2 text-sm">Water Recovery Time (hrs)</th>
                        <th class="border p-2 text-sm">Water Heated (${volumeRateUnit})</th>
                        <th class="border p-2 text-sm">Meets Hot Water Demand</th>
                        <th class="border p-2 text-sm">Meets Total BTU Requirement</th>
                        <th class="border p-2 text-sm">Acceptable</th>
                    </tr>
                </thead>
                <tbody>
    `;

    results.forEach(result => {
        const rowColor = result.acceptable ? 'bg-green-100' : 'bg-red-100';
        html += `
            <tr class="${rowColor}">
                <td class="border p-2 text-gray-700 text-sm">${result.model}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.sandHoursSafety}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.stoneHoursSafety}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.fulltankHoursSafety}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.waterRecoveryHoursSafety}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.waterHeatedPerHour}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.meetsHotWaterDemand}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.meetsTotalBtuRequirement}</td>
                <td class="border p-2 text-gray-700 text-sm">${result.acceptable ? 'Yes' : 'No'}</td>
            </tr>
        `;
    });

    html += `
                </tbody>
            </table>
            <p class="text-sm text-gray-600 mb-4">Note: Calculations include safety margins (30% for sand/stone, 20% for water up to 140°F, 390% above 140°F).</p>
            <button onclick="downloadPDF()" class="w-full bg-green-600 text-white p-2 rounded-md hover:bg-green-700 text-sm">Download PDF</button>
        </div>
    `;

    const result = document.getElementById('result');
    result.innerHTML = html;

    // Store results for PDF generation
    result.dataset.batchRate = batchRate.toFixed(2);
    result.dataset.dailyBatch = dailyBatch.toFixed(2);
    result.dataset.truckSize = truckSize.toFixed(2);
    result.dataset.sandStartTemp = sandStartTemp.toFixed(1);
    result.dataset.sandEndTemp = sandEndTemp.toFixed(1);
    result.dataset.stoneStartTemp = stoneStartTemp.toFixed(1);
    result.dataset.stoneEndTemp = stoneEndTemp.toFixed(1);
    result.dataset.tankSize = tankSize.toFixed(2);
    result.dataset.saddleTankSize = saddleTankSize.toFixed(2);
    result.dataset.waterStartTemp = waterStartTemp.toFixed(1);
    result.dataset.waterEndTemp = waterEndTemp.toFixed(1);
    result.dataset.hotWaterRatio = hotWaterRatio * 100; // Convert back to percentage
    result.dataset.blendedTemp = document.getElementById('blendedTempDisplay').value;
    result.dataset.totalBtuPerfect = totalBtuPerfect.toLocaleString(undefined, { maximumFractionDigits: 2 });
    result.dataset.totalBtuReal = totalBtuReal.toLocaleString(undefined, { maximumFractionDigits: 2 });
    result.dataset.waterPerHour = waterPerHourDisplay.toFixed(2);
    result.dataset.saddleWaterPerHour = saddleWaterPerHourDisplay.toFixed(2);
    result.dataset.totalWaterPerHour = totalWaterPerHourDisplay.toFixed(2);
    result.dataset.hotWaterPerHour = hotWaterPerHourDisplay.toFixed(2);
    result.dataset.volumeRateUnit = volumeRateUnit;
    result.dataset.volumeUnit = volumeUnit;
    result.dataset.tempUnit = isMetric ? '°C' : '°F';
    result.dataset.batchUnit = isMetric ? 'm³/hr' : 'yd³/hr';
    result.dataset.batchVolumeUnit = isMetric ? 'm³' : 'yd³';
    result.dataset.dailyBatchUnit = isMetric ? 'm³/day' : 'yd³/day';
    result.dataset.results = JSON.stringify(results);
    result.dataset.mode = mode;
    result.dataset.customer = customer;
}

    function drawCompanyHeader(doc, y) {
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.setFont('helvetica', 'bold');
        doc.text("Steam Engineering - A Division of Vortomech Industries Inc.", 10, y);
        doc.setFontSize(10);
        doc.setFont('helvetica', 'normal');
        doc.text("T: +1(647) 749-4064", 10, y + 5);
        doc.text("E: contactus@vortomech.com", 10, y + 10);
        return y + 20;
    }

function drawCustomerInfo(doc, y, customer) {
    if (customer) {
        doc.setFontSize(12);
        doc.setTextColor(79, 70, 229); // indigo-600
        doc.setFont('helvetica', 'bold');
        doc.text("Customer Information", 10, y);
        doc.setFontSize(10);
        doc.setTextColor(55, 65, 81); // gray-700
        doc.setFont('helvetica', 'normal');
        doc.text(`Customer: ${customer}`, 10, y + 10);
        return y + 20;
    }
    return y;
}

function drawTitleAndMeta(doc, y, mode) {
    doc.setFontSize(14);
    doc.setTextColor(79, 70, 229); // indigo-600
    doc.setFont('helvetica', 'bold');
    doc.text("Ready-Mix Concrete System Sizing Calculator Results", 10, y);
    
    // Add subtitle based on mode
    doc.setFontSize(12);
    doc.setTextColor(55, 65, 81); // gray-700
    doc.setFont('helvetica', 'normal');
    const subtitle = mode === 'everything' ? 'Everything On-Demand' : 'Water On-Demand';
    doc.text(subtitle, 10, y + 7); // Position subtitle 7 units below the title

    // Adjust spacing for the remaining text
    doc.setFontSize(10);
    const now = new Date();
    const dateStr = now.toLocaleDateString();
    const timeStr = now.toLocaleTimeString();
    doc.text(`Generated on: ${dateStr} ${timeStr}`, 10, y + 17); // Adjusted position
    doc.text("Calculator: Version 33", 10, y + 22); // Adjusted position
    return y + 32; // Increased return value to account for extra line
}

    function drawUnitSystem(doc, y, unitSystem) {
        doc.setFontSize(12);
        doc.setTextColor(79, 70, 229); // indigo-600
        doc.setFont('helvetica', 'bold');
        doc.text("Unit System", 10, y);
        doc.setFontSize(10);
        doc.setTextColor(55, 65, 81); // gray-700
        doc.setFont('helvetica', 'normal');
        doc.text(`Unit System: ${unitSystem === 'metric' ? 'Metric (m³, °C)' : 'Imperial (yd³, °F)'}`, 10, y + 10);
        return y + 20;
    }

    function drawInputParameters(doc, y, batchRate, dailyBatch, truckSize, sandStartTemp, sandEndTemp, stoneStartTemp, stoneEndTemp, tankSize, saddleTankSize, waterStartTemp, waterEndTemp, hotWaterRatio, blendedTemp, batchUnit, dailyBatchUnit, batchVolumeUnit, volumeUnit, tempUnit) {
        doc.setFontSize(12);
        doc.setTextColor(79, 70, 229); // indigo-600
        doc.setFont('helvetica', 'bold');
        doc.text("Input Parameters", 10, y);
        doc.setFontSize(10);
        doc.setTextColor(55, 65, 81); // gray-700
        doc.setFont('helvetica', 'normal');
        doc.text(`Batching Rate: ${batchRate} ${batchUnit}`, 10, y + 10);
        doc.text(`Daily Production: ${dailyBatch} ${dailyBatchUnit}`, 10, y + 15);
        doc.text(`Truck Size: ${truckSize} ${batchVolumeUnit}`, 10, y + 20);
        doc.text(`Sand Inlet Temp: ${sandStartTemp} ${tempUnit}`, 10, y + 25);
        doc.text(`Sand Discharge Temp: ${sandEndTemp} ${tempUnit}`, 10, y + 30);
        doc.text(`Stone Inlet Temp: ${stoneStartTemp} ${tempUnit}`, 10, y + 35);
        doc.text(`Stone Discharge Temp: ${stoneEndTemp} ${tempUnit}`, 10, y + 40);
        doc.text(`Tank Size: ${tankSize} ${volumeUnit}`, 10, y + 45);
        doc.text(`Saddle Tank Size: ${saddleTankSize} ${volumeUnit}`, 10, y + 50);
        doc.text(`Water Inlet Temp: ${waterStartTemp} ${tempUnit}`, 10, y + 55);
        doc.text(`Water Discharge Temp: ${waterEndTemp} ${tempUnit}`, 10, y + 60);
        doc.text(`Hot Water Blend Ratio: ${hotWaterRatio}%`, 10, y + 65);
        doc.text(`Blended Water Temp: ${blendedTemp} ${tempUnit}`, 10, y + 70);
        return y + 80;
    }

    function drawCalculatedResults(doc, y, totalBtuPerfect, totalBtuReal, waterPerHour, saddleWaterPerHour, totalWaterPerHour, hotWaterPerHour, volumeRateUnit) {
        doc.setFontSize(12);
        doc.setTextColor(79, 70, 229); // indigo-600
        doc.setFont('helvetica', 'bold');
        doc.text("Calculated Results", 10, y);
        doc.setFontSize(10);
        doc.setTextColor(55, 65, 81); // gray-700
        doc.setFont('helvetica', 'normal');
        doc.text(`Total BTU/HR Requirement (Ideal): ${totalBtuPerfect} BTU/hr`, 10, y + 10);
        doc.text(`Total BTU/HR Requirement (Realistic): ${totalBtuReal} BTU/hr`, 10, y + 15);
        doc.text(`Mix Water: ${waterPerHour} ${volumeRateUnit}`, 10, y + 20);
        doc.text(`Saddle Tank Water: ${saddleWaterPerHour} ${volumeRateUnit}`, 10, y + 25);
        doc.text(`Total Water Demand: ${totalWaterPerHour} ${volumeRateUnit}`, 10, y + 30);
        doc.text(`Hot Water Demand: ${hotWaterPerHour} ${volumeRateUnit}`, 10, y + 35);
        return y + 45;
    }

    function drawSteamGeneratorTable(doc, y, results, volumeRateUnit) {
        doc.setFontSize(12);
        doc.setTextColor(79, 70, 229); // indigo-600
        doc.setFont('helvetica', 'bold');
        doc.text("Steam Generator Sizing", 10, y);
        y += 10;

        const tableData = results.map(result => [
            result.model,
            result.sandHoursSafety,
            result.stoneHoursSafety,
            result.fulltankHoursSafety,
            result.waterRecoveryHoursSafety,
            result.waterHeatedPerHour,
            result.meetsHotWaterDemand,
            result.meetsTotalBtuRequirement,
            result.acceptable ? 'Yes' : 'No'
        ]);

        doc.autoTable({
            startY: y,
            head: [['Model', 'Sand Heat Time (hrs)', 'Stone Heat Time (hrs)', 'Full Tank Heat Time (hrs)', 'Water Recovery Time (hrs)', `Water Heated (${volumeRateUnit})`, 'Meets Hot Water Demand', 'Meets Total BTU Requirement', 'Acceptable']],
            body: tableData,
            theme: 'grid',
            styles: { fontSize: 8, cellPadding: 2, textColor: [55, 65, 81] },
            headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255] },
            alternateRowStyles: { fillColor: [255, 255, 255] },
            didParseCell: (data) => {
                if (data.section === 'body' && data.column.index === 8) {
                    data.cell.styles.fillColor = data.row.raw[8] === 'Yes' ? [220, 252, 231] : [254, 202, 202];
                }
            }
        });

        y = doc.lastAutoTable.finalY + 5;
        doc.setFontSize(10);
        doc.setTextColor(55, 65, 81); // gray-700
        doc.setFont('helvetica', 'normal');
        doc.text("Note: Calculations include safety margins (30% for sand/stone, 20% for water up to 140°F, 390% above 140°F).", 10, y);
        return y + 10;
    }

function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 10;

    const result = document.getElementById('result');
    const batchRate = result.dataset.batchRate;
    const dailyBatch = result.dataset.dailyBatch;
    const truckSize = result.dataset.truckSize;
    const sandStartTemp = result.dataset.sandStartTemp;
    const sandEndTemp = result.dataset.sandEndTemp;
    const stoneStartTemp = result.dataset.stoneStartTemp;
    const stoneEndTemp = result.dataset.stoneEndTemp;
    const tankSize = result.dataset.tankSize;
    const saddleTankSize = result.dataset.saddleTankSize;
    const waterStartTemp = result.dataset.waterStartTemp;
    const waterEndTemp = result.dataset.waterEndTemp;
    const hotWaterRatio = result.dataset.hotWaterRatio;
    const blendedTemp = result.dataset.blendedTemp;
    const totalBtuPerfect = result.dataset.totalBtuPerfect;
    const totalBtuReal = result.dataset.totalBtuReal;
    const waterPerHour = result.dataset.waterPerHour;
    const saddleWaterPerHour = result.dataset.saddleWaterPerHour;
    const totalWaterPerHour = result.dataset.totalWaterPerHour;
    const hotWaterPerHour = result.dataset.hotWaterPerHour;
    const volumeRateUnit = result.dataset.volumeRateUnit;
    const volumeUnit = result.dataset.volumeUnit;
    const tempUnit = result.dataset.tempUnit;
    const batchUnit = result.dataset.batchUnit;
    const dailyBatchUnit = result.dataset.dailyBatchUnit;
    const batchVolumeUnit = result.dataset.batchVolumeUnit;
    const results = JSON.parse(result.dataset.results);
    const unitSystem = lastUnitSystem;
    const mode = result.dataset.mode;
    const customer = result.dataset.customer;

    y = drawCompanyHeader(doc, y);
    y = drawCustomerInfo(doc, y, customer);
    y = drawTitleAndMeta(doc, y, mode);
    y = drawUnitSystem(doc, y, unitSystem);
    y = drawInputParameters(doc, y, batchRate, dailyBatch, truckSize, sandStartTemp, sandEndTemp, stoneStartTemp, stoneEndTemp, tankSize, saddleTankSize, waterStartTemp, waterEndTemp, hotWaterRatio, blendedTemp, batchUnit, dailyBatchUnit, batchVolumeUnit, volumeUnit, tempUnit);
    y = drawCalculatedResults(doc, y, totalBtuPerfect, totalBtuReal, waterPerHour, saddleWaterPerHour, totalWaterPerHour, hotWaterPerHour, volumeRateUnit);
    y = drawSteamGeneratorTable(doc, y, results, volumeRateUnit);

    // Generate local timestamp for filename
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const timestamp = `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
    doc.save(`ReadyMix_SystemSizing_${timestamp}.pdf`);
}

    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        // Initial render of the hopper heating table
        updateHopperHeatingTable();

        const tabs = document.querySelectorAll('.tab-button');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => {
                    t.classList.remove('text-indigo-600', 'border-indigo-600');
                    t.classList.add('text-gray-600');
                });
                tab.classList.add('text-indigo-600', 'border-indigo-600');

                const tabContents = document.querySelectorAll('.tab-content');
                tabContents.forEach(content => content.classList.add('hidden'));

                const target = document.getElementById(`content-${tab.id.split('-')[1]}`);
                target.classList.remove('hidden');

                // Update the hopper heating table when the Steel Hopper Heating tab is made visible
                if (tab.id === 'tab-hopper') {
                    updateHopperHeatingTable();
                }
            });
        });

        document.getElementById('btn-everything').addEventListener('click', () => calculateSizing('everything'));
        document.getElementById('btn-water').addEventListener('click', () => calculateSizing('water'));
    });
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'93836e62efc0bf91',t:'MTc0NTk3ODI3Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
